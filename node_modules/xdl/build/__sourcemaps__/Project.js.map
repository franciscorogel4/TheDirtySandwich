{"version":3,"sources":["Project.js"],"names":["async","projectDir","manifestUrl","await","UrlUtils","constructManifestUrlAsync","urlType","packagerUrl","constructBundleUrlAsync","let","packagerRunning","res","request","promise","statusCode","e","manifestServerRunning","currentStatus","projectRoot","ErrorCode","NO_PROJECT_ROOT","_assertValidProjectRoot","rangeStart","port","freeportAsync","NO_PORT_FOUND","_getFreePortAsync","url","platform","errorCode","minLength","getPlatformSpecificBundleUrl","fullUrl","response","get","headers","body","JSON","parse","message","ProjectUtils","logError","length","_getForPlatformAsync","manifest","resolver","assetSchemas","ExpSchema","getAssetSchemasAsync","sdkVersion","filter","fieldPath","_","urls","Promise","all","map","pathOrURL","fs","existsSync","path","resolve","forEach","index","set","logWarning","_resolveManifestAssets","options","user","UserManager","ensureLoggedInAsync","Analytics","logEvent","schema","joi","object","keys","validate","INVALID_OPTIONS","toString","packagerInfo","ProjectSettings","readPackagerInfoAsync","packagerPort","NO_PACKAGER_PORT","exp","pkg","readConfigJsonAsync","configName","configFilenameAsync","NO_PACKAGE_JSON","version","slug","name","android","config","ios","includes","entryPoint","Exp","determineEntryPointAsync","publishUrl","constructPublishUrlAsync","assetsUrl","constructAssetsUrlAsync","iosBundle","androidBundle","iosAssetsJson","androidAssetsJson","INVALID_BUNDLE","MINIMUM_BUNDLE_SIZE","INVALID_ASSETS","manifestAssets","assetPath","absolutePath","contents","readFile","hash","md5hex","push","files","fileHashes","iosAssets","androidAssets","assets","concat","uploadAssetsAsync","formData","expJson","stringify","value","filename","Api","callMethodAsync","publishBundlePath","writeFile","isKernel","kernelBundleUrl","Config","api","scheme","host","username","kernel","androidManifestPath","ExponentTools","getManifestAsync","bundleUrl","iosManifestPath","publishAsync","paths","asset","metas","Object","metadata","missing","key","exists","chunk","logDebug","createReadStream","current","boolean","mode","string","any","valid","expIds","array","configPrefix","bundleIdentifier","INVALID_MANIFEST","package","buildAsync","delayAsync","_waitForRunningAsync","result","spawnAsync","stdout","logInfo","_restartWatchmanAsync","verbose","stopReactNativeServerAsync","Watchman","addToPathAsync","unblockAndGetVersionAsync","packagerOpts","projectRoots","customLogReporterPath","assetExts","Versions","gteSdkVersion","userPackagerOpts","uniq","cliOpts","reduce","opts","val","reset","defaultCliPath","join","cliPath","nodePath","rnCliPath","_nodePathForProjectRoot","packagerProcess","child_process","fork","cwd","env","process","NODE_PATH","ELECTRON_RUN_AS_NODE","silent","setPackagerInfoAsync","packagerPid","pid","on","treekill","setEncoding","stderr","data","_logPackagerOutput","code","hostType","startReactNativeServerAsync","stopExpoServerAsync","app","express","use","bodyParser","json","limit","urlencoded","extended","Doctor","validateWithNetworkAsync","FATAL","Error","manifestHandler","req","getPackagerOptsAsync","bundleUrlPackagerOpts","xde","developer","tool","developerTool","startsWith","mainModuleName","guessMainModulePath","queryParams","constructBundleQueryParamsAsync","hostname","debuggerHost","constructDebuggerHostAsync","logUrl","match","hostUUID","UserSettings","anonymousIdentifier","offline","id","manifestString","currentUser","getCurrentUserAsync","_cachedSignedManifest","signedManifest","unsignedManifest","signature","publishInfo","getPublishInfoAsync","args","hostInfo","server","serverVersion","require","serverDriver","serverOS","os","serverOSVersion","release","append","send","stack","status","error","post","deviceId","deviceName","_handleDeviceLogs","close","expRc","readExpRcAsync","expoServerPort","manifestPort","listen","address","saveRecentExpRootAsync","startExpoServerAsync","hostnameAsync","ngrokPid","attempts","configPath","dotExpoHomeDirectory","ngrok","connect","NGROK_ERROR","error_code","kill","resetProjectRandomnessAsync","_connectToNgrokAsync","NO_EXPO_SERVER_PORT","stopTunnelsAsync","Android","startAdbReverseAsync","clearNotification","packageShortName","base","expoServerNgrokUrl","authtoken","authToken","proto","randomness","manifestTunnelRandomness","getProjectRandomnessAsync","domainify","domain","packagerNgrokUrl","startTunnelsAsync","ngrokProcess","ngrokProcessPid","stopAdbReverseAsync","number","integer","setOptionsAsync","getUrlAsync","startAsync","_stopInternalAsync","race","reject","setTimeout","stopAsync","_stripPackagerOutputBox","output","re","found","_processPackagerLine","line","timestampRe","sdk11AndUpTimestampRe","replace","level","isPlatformSupported","lines","split","i","logs","log","obj","groupDepth","shouldHide","logWithLevel","tag","directory","parentDirectory","dirname","delimiter"],"mappings":"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","file":"../Project.js","sourcesContent":["/**\n * @flow\n */\n\nimport 'instapromise';\n\nimport bodyParser from 'body-parser';\nimport child_process from 'child_process';\nimport delayAsync from 'delay-async';\nimport express from 'express';\nimport freeportAsync from 'freeport-async';\nimport fs from 'fs';\nimport joi from 'joi';\nimport _ from 'lodash';\nimport ngrok from '@exponent/ngrok';\nimport os from 'os';\nimport path from 'path';\nimport request from 'request';\nimport spawnAsync from '@exponent/spawn-async';\nimport treekill from 'tree-kill';\nimport md5hex from 'md5hex';\n\nimport * as Analytics from './Analytics';\nimport * as Android from './Android';\nimport Api from './Api';\nimport Config from './Config';\nimport * as Doctor from './project/Doctor';\nimport ErrorCode from './ErrorCode';\nimport * as ExponentTools from './detach/ExponentTools';\nimport * as Exp from './Exp';\nimport * as ExpSchema from './project/ExpSchema';\nimport * as ProjectSettings from './ProjectSettings';\nimport * as ProjectUtils from './project/ProjectUtils';\nimport * as UrlUtils from './UrlUtils';\nimport UserManager from './User';\nimport UserSettings from './UserSettings';\nimport * as Versions from './Versions';\nimport * as Watchman from './Watchman';\nimport XDLError from './XDLError';\n\nimport type { User as ExpUser } from './User'; //eslint-disable-line\n\nconst MINIMUM_BUNDLE_SIZE = 500;\n\ntype CachedSignedManifest = {\n  manifestString: ?string,\n  signedManifest: ?string,\n};\n\nlet _cachedSignedManifest: CachedSignedManifest = {\n  manifestString: null,\n  signedManifest: null,\n};\n\nexport type ProjectStatus = 'running' | 'ill' | 'exited';\n\nexport async function currentStatus(\n  projectDir: string\n): Promise<ProjectStatus> {\n  const manifestUrl = await UrlUtils.constructManifestUrlAsync(projectDir, {\n    urlType: 'http',\n  });\n  const packagerUrl = await UrlUtils.constructBundleUrlAsync(projectDir, {\n    urlType: 'http',\n  });\n\n  let packagerRunning = false;\n  try {\n    const res = await request.promise(`${packagerUrl}/debug`);\n\n    if (res.statusCode < 400) {\n      packagerRunning = true;\n    }\n  } catch (e) {}\n\n  let manifestServerRunning = false;\n  try {\n    const res = await request.promise(manifestUrl);\n    if (res.statusCode < 400) {\n      manifestServerRunning = true;\n    }\n  } catch (e) {}\n\n  if (packagerRunning && manifestServerRunning) {\n    return 'running';\n  } else if (packagerRunning || manifestServerRunning) {\n    return 'ill';\n  } else {\n    return 'exited';\n  }\n}\n\nasync function _assertValidProjectRoot(projectRoot) {\n  if (!projectRoot) {\n    throw new XDLError(ErrorCode.NO_PROJECT_ROOT, 'No project root specified');\n  }\n}\n\nasync function _getFreePortAsync(rangeStart) {\n  let port = await freeportAsync(rangeStart);\n  if (!port) {\n    throw new XDLError(ErrorCode.NO_PORT_FOUND, 'No available port found');\n  }\n\n  return port;\n}\n\nasync function _getForPlatformAsync(\n  projectRoot,\n  url,\n  platform,\n  { errorCode, minLength }\n) {\n  url = UrlUtils.getPlatformSpecificBundleUrl(url, platform);\n\n  let fullUrl = `${url}&platform=${platform}`;\n  let response = await request.promise.get({\n    url: fullUrl,\n    headers: {\n      'Exponent-Platform': platform,\n    },\n  });\n\n  if (response.statusCode !== 200) {\n    if (response.body) {\n      let body = JSON.parse(response.body);\n      if (body && body.message) {\n        ProjectUtils.logError(projectRoot, 'expo', body.message);\n      }\n    }\n    throw new XDLError(\n      errorCode,\n      `Packager url ${fullUrl} returned unexpected code ${response.statusCode}. Please open your project in the Expo app and see if there are any errors. Also scroll up and make sure there were no errors or warnings when opening your project.`\n    );\n  }\n\n  if (!response.body || (minLength && response.body.length < minLength)) {\n    throw new XDLError(errorCode, `Body is: ${response.body}`);\n  }\n\n  return response.body;\n}\n\nasync function _resolveManifestAssets(projectRoot, manifest, resolver) {\n  try {\n    // Asset fields that the user has set\n    const assetSchemas = (await ExpSchema.getAssetSchemasAsync(\n      manifest.sdkVersion\n    )).filter(({ fieldPath }) => _.get(manifest, fieldPath));\n\n    // Get the URLs\n    const urls = await Promise.all(\n      assetSchemas.map(async ({ fieldPath }) => {\n        const pathOrURL = _.get(manifest, fieldPath);\n        if (fs.existsSync(path.resolve(projectRoot, pathOrURL))) {\n          return await resolver(pathOrURL);\n        } else {\n          return pathOrURL; // Assume already a URL\n        }\n      })\n    );\n\n    // Set the corresponding URL fields\n    assetSchemas.forEach(({ fieldPath }, index) =>\n      _.set(manifest, fieldPath + 'Url', urls[index])\n    );\n  } catch (e) {\n    ProjectUtils.logWarning(\n      projectRoot,\n      'expo',\n      `Warning: Unable to resolve manifest assets. Icons might not work. ${e.message}.`\n    );\n  }\n}\n\nexport async function publishAsync(projectRoot: string, options: Object = {}) {\n  const user = await UserManager.ensureLoggedInAsync();\n  _assertValidProjectRoot(projectRoot);\n\n  Analytics.logEvent('Publish', {\n    projectRoot,\n  });\n\n  let schema = joi.object().keys(\n    {\n      // empty\n    }\n  );\n\n  try {\n    await joi.promise.validate(options, schema);\n  } catch (e) {\n    throw new XDLError(ErrorCode.INVALID_OPTIONS, e.toString());\n  }\n\n  let packagerInfo = await ProjectSettings.readPackagerInfoAsync(projectRoot);\n  if (!packagerInfo.packagerPort) {\n    throw new XDLError(\n      ErrorCode.NO_PACKAGER_PORT,\n      `No packager found for project at ${projectRoot}.`\n    );\n  }\n\n  let { exp, pkg } = await ProjectUtils.readConfigJsonAsync(projectRoot);\n\n  if (!exp || !pkg) {\n    const configName = await ProjectUtils.configFilenameAsync(projectRoot);\n    throw new XDLError(\n      ErrorCode.NO_PACKAGE_JSON,\n      `Couldn't read ${configName} file in project at ${projectRoot}`\n    );\n  }\n\n  // Support version and name being specified in package.json for legacy\n  // support pre: exp.json\n  if (!exp.version && pkg.version) {\n    exp.version = pkg.version;\n  }\n  if (!exp.slug && pkg.name) {\n    exp.slug = pkg.name;\n  }\n\n  if (exp.android && exp.android.config) {\n    delete exp.android.config;\n  }\n\n  if (exp.ios && exp.ios.config) {\n    delete exp.ios.config;\n  }\n\n  // Only allow test-suite to be published with UNVERSIONED\n  if (exp.sdkVersion === 'UNVERSIONED' && !exp.slug.includes('test-suite')) {\n    throw new XDLError(\n      ErrorCode.INVALID_OPTIONS,\n      'Cannot publish with sdkVersion UNVERSIONED.'\n    );\n  }\n\n  let entryPoint = await Exp.determineEntryPointAsync(projectRoot);\n  let publishUrl = await UrlUtils.constructPublishUrlAsync(\n    projectRoot,\n    entryPoint\n  );\n  let assetsUrl = await UrlUtils.constructAssetsUrlAsync(\n    projectRoot,\n    entryPoint\n  );\n  let [\n    iosBundle,\n    androidBundle,\n    iosAssetsJson,\n    androidAssetsJson,\n  ] = await Promise.all([\n    _getForPlatformAsync(projectRoot, publishUrl, 'ios', {\n      errorCode: ErrorCode.INVALID_BUNDLE,\n      minLength: MINIMUM_BUNDLE_SIZE,\n    }),\n    _getForPlatformAsync(projectRoot, publishUrl, 'android', {\n      errorCode: ErrorCode.INVALID_BUNDLE,\n      minLength: MINIMUM_BUNDLE_SIZE,\n    }),\n    _getForPlatformAsync(projectRoot, assetsUrl, 'ios', {\n      errorCode: ErrorCode.INVALID_ASSETS,\n    }),\n    _getForPlatformAsync(projectRoot, assetsUrl, 'android', {\n      errorCode: ErrorCode.INVALID_ASSETS,\n    }),\n  ]);\n\n  // Resolve manifest assets to their S3 URL and add them to the list of assets to\n  // be uploaded\n  const manifestAssets = [];\n  await _resolveManifestAssets(projectRoot, exp, async assetPath => {\n    const absolutePath = path.resolve(projectRoot, assetPath);\n    const contents = await fs.promise.readFile(absolutePath);\n    const hash = md5hex(contents);\n    manifestAssets.push({ files: [absolutePath], fileHashes: [hash] });\n    return 'https://d1wp6m56sqw74a.cloudfront.net/~assets/' + hash;\n  });\n\n  // Upload asset files\n  const iosAssets = JSON.parse(iosAssetsJson);\n  const androidAssets = JSON.parse(androidAssetsJson);\n  const assets = iosAssets.concat(androidAssets).concat(manifestAssets);\n  if (assets.length > 0 && assets[0].fileHashes) {\n    await uploadAssetsAsync(projectRoot, assets);\n  }\n\n  let formData = {\n    expJson: JSON.stringify(exp),\n    iosBundle: {\n      value: iosBundle,\n      options: {\n        filename: 'iosBundle',\n      },\n    },\n    androidBundle: {\n      value: androidBundle,\n      options: {\n        filename: 'androidBundle',\n      },\n    },\n  };\n\n  let response = await Api.callMethodAsync('publish', [options], 'put', null, {\n    formData,\n  });\n\n  if (exp.android && exp.android.publishBundlePath) {\n    await fs.promise.writeFile(\n      path.resolve(projectRoot, exp.android.publishBundlePath),\n      androidBundle\n    );\n  }\n\n  if (exp.ios && exp.ios.publishBundlePath) {\n    await fs.promise.writeFile(\n      path.resolve(projectRoot, exp.ios.publishBundlePath),\n      iosBundle\n    );\n  }\n\n  if (exp.isKernel) {\n    let kernelBundleUrl = `${Config.api.scheme}://${Config.api.host}`;\n    if (Config.api.port) {\n      kernelBundleUrl = `${kernelBundleUrl}:${Config.api.port}`;\n    }\n    kernelBundleUrl = `${kernelBundleUrl}/@${user.username}/${exp.slug}/bundle`;\n\n    if (exp.kernel.androidManifestPath) {\n      let manifest = await ExponentTools.getManifestAsync(response.url, {\n        'Exponent-SDK-Version': exp.sdkVersion,\n        'Exponent-Platform': 'android',\n      });\n      manifest.bundleUrl = kernelBundleUrl;\n      manifest.sdkVersion = 'UNVERSIONED';\n      await fs.promise.writeFile(\n        path.resolve(projectRoot, exp.kernel.androidManifestPath),\n        JSON.stringify(manifest)\n      );\n    }\n\n    if (exp.kernel.iosManifestPath) {\n      let manifest = await ExponentTools.getManifestAsync(response.url, {\n        'Exponent-SDK-Version': exp.sdkVersion,\n        'Exponent-Platform': 'ios',\n      });\n      manifest.bundleUrl = kernelBundleUrl;\n      manifest.sdkVersion = 'UNVERSIONED';\n      await fs.promise.writeFile(\n        path.resolve(projectRoot, exp.kernel.iosManifestPath),\n        JSON.stringify(manifest)\n      );\n    }\n  }\n\n  return response;\n}\n\n// TODO(jesse): Add analytics for upload\nasync function uploadAssetsAsync(projectRoot, assets) {\n  // Collect paths by key, also effectively handles duplicates in the array\n  const paths = {};\n  assets.forEach(asset => {\n    asset.files.forEach((path, index) => {\n      paths[asset.fileHashes[index]] = path;\n    });\n  });\n\n  // Collect list of assets missing on host\n  const metas = (await Api.callMethodAsync('assetsMetadata', [], 'post', {\n    keys: Object.keys(paths),\n  })).metadata;\n  const missing = Object.keys(paths).filter(key => !metas[key].exists);\n\n  // Upload them!\n  await Promise.all(\n    _.chunk(missing, 5).map(async keys => {\n      let formData = {};\n      keys.forEach(key => {\n        ProjectUtils.logDebug(projectRoot, 'expo', `uploading ${paths[key]}`);\n        formData[key] = {\n          value: fs.createReadStream(paths[key]),\n          options: {\n            filename: paths[key],\n          },\n        };\n      });\n      await Api.callMethodAsync('uploadAssets', [], 'put', null, { formData });\n    })\n  );\n}\n\nexport async function buildAsync(\n  projectRoot: string,\n  options: {\n    current?: boolean,\n    mode?: string,\n    platform?: string,\n    expIds?: Array<string>,\n  } = {}\n) {\n  await UserManager.ensureLoggedInAsync();\n  _assertValidProjectRoot(projectRoot);\n\n  Analytics.logEvent('Build Shell App', {\n    projectRoot,\n  });\n\n  let schema = joi.object().keys({\n    current: joi.boolean(),\n    mode: joi.string(),\n    platform: joi.any().valid('ios', 'android', 'all'),\n    expIds: joi.array(),\n  });\n\n  try {\n    await joi.promise.validate(options, schema);\n  } catch (e) {\n    throw new XDLError(ErrorCode.INVALID_OPTIONS, e.toString());\n  }\n\n  let { exp, pkg } = await ProjectUtils.readConfigJsonAsync(projectRoot);\n  const configName = await ProjectUtils.configFilenameAsync(projectRoot);\n  const configPrefix = configName === 'app.json' ? 'expo.' : '';\n\n  if (!exp || !pkg) {\n    throw new XDLError(\n      ErrorCode.NO_PACKAGE_JSON,\n      `Couldn't read ${configName} file in project at ${projectRoot}`\n    );\n  }\n\n  // Support version and name being specified in package.json for legacy\n  // support pre: exp.json\n  if (!exp.version && pkg.version) {\n    exp.version = pkg.version;\n  }\n  if (!exp.slug && pkg.name) {\n    exp.slug = pkg.name;\n  }\n\n  if (options.platform === 'ios' || options.platform === 'all') {\n    if (!exp.ios || !exp.ios.bundleIdentifier) {\n      throw new XDLError(\n        ErrorCode.INVALID_MANIFEST,\n        `Must specify a bundle identifier in order to build this experience for iOS. Please specify one in ${configName} at \"${configPrefix}ios.bundleIdentifier\"`\n      );\n    }\n  }\n\n  if (options.platform === 'android' || options.platform === 'all') {\n    if (!exp.android || !exp.android.package) {\n      throw new XDLError(\n        ErrorCode.INVALID_MANIFEST,\n        `Must specify a java package in order to build this experience for Android. Please specify one in ${configName} at \"${configPrefix}android.package\"`\n      );\n    }\n  }\n\n  let response = await Api.callMethodAsync('build', [], 'put', {\n    manifest: exp,\n    options,\n  });\n\n  return response;\n}\n\nasync function _waitForRunningAsync(url) {\n  try {\n    let response = await request.promise(url);\n    // Looking for \"Cached Bundles\" string is hacky, but unfortunately\n    // ngrok returns a 200 when it succeeds but the port it's proxying\n    // isn't bound.\n    if (\n      response.statusCode >= 200 &&\n      response.statusCode < 300 &&\n      response.body &&\n      response.body.includes('Cached Bundles')\n    ) {\n      return true;\n    }\n  } catch (e) {\n    // Try again after delay\n  }\n\n  await delayAsync(100);\n  return _waitForRunningAsync(url);\n}\n\nfunction _stripPackagerOutputBox(output: string) {\n  let re = /Running packager on port (\\d+)/;\n  let found = output.match(re);\n  if (found && found.length >= 2) {\n    return `Running packager on port ${found[1]}\\n`;\n  } else {\n    return null;\n  }\n}\n\nfunction _processPackagerLine(line: string) {\n  // [10:02:59 AM]\n  let timestampRe = /\\s*\\[\\d+\\:\\d+\\:\\d+\\ (AM)?(PM)?\\]\\s+/;\n  // [11/8/2016, 10:02:59 AM]\n  let sdk11AndUpTimestampRe = /\\s*\\[\\d+\\/\\d+\\/\\d+, \\d+\\:\\d+\\:\\d+\\ (AM)?(PM)?\\]\\s+/;\n  return line.replace(timestampRe, '').replace(sdk11AndUpTimestampRe, '');\n}\n\nasync function _restartWatchmanAsync(projectRoot: string) {\n  try {\n    let result = await spawnAsync('watchman', ['watch-del', projectRoot]);\n    await spawnAsync('watchman', ['watch-project', projectRoot]);\n    if (result.stdout.includes('root')) {\n      ProjectUtils.logInfo(projectRoot, 'expo', 'Restarted watchman.');\n      return;\n    }\n  } catch (e) {}\n\n  ProjectUtils.logError(\n    projectRoot,\n    'expo',\n    'Attempted to restart watchman but failed. Please try running `watchman watch-del-all`.'\n  );\n}\n\nfunction _logPackagerOutput(projectRoot: string, level: string, data: Object) {\n  let output = data.toString();\n  if (output.includes('─────')) {\n    output = _stripPackagerOutputBox(output);\n    if (output) {\n      ProjectUtils.logInfo(projectRoot, 'expo', output);\n    }\n    return;\n  }\n  if (!output) {\n    return;\n  } // Fix watchman if it's being dumb\n  if (Watchman.isPlatformSupported() && output.includes('watchman watch-del')) {\n    _restartWatchmanAsync(projectRoot);\n    return;\n  }\n  let lines = output.split(/\\r?\\n/);\n  for (let i = 0; i < lines.length; i++) {\n    lines[i] = _processPackagerLine(lines[i]);\n  }\n  output = lines.join('\\n');\n  if (level === 'info') {\n    ProjectUtils.logInfo(projectRoot, 'packager', output);\n  } else {\n    ProjectUtils.logError(projectRoot, 'packager', output);\n  }\n}\nfunction _handleDeviceLogs(\n  projectRoot: string,\n  deviceId: string,\n  deviceName: string,\n  logs: any\n) {\n  for (let i = 0; i < logs.length; i++) {\n    let log = logs[i];\n    let body = typeof log.body === 'string' ? [log.body] : log.body;\n    let string = body\n      .map(obj => {\n        if (typeof obj === 'undefined') {\n          return 'undefined';\n        }\n        if (obj === 'null') {\n          return 'null';\n        }\n        if (\n          typeof obj === 'string' ||\n          typeof obj === 'number' ||\n          typeof obj === 'boolean'\n        ) {\n          return obj;\n        }\n        try {\n          return JSON.stringify(obj);\n        } catch (e) {\n          return obj.toString();\n        }\n      })\n      .join(' ');\n    let level = log.level;\n    let groupDepth = log.groupDepth;\n    let shouldHide = log.shouldHide;\n    ProjectUtils.logWithLevel(\n      projectRoot,\n      level,\n      {\n        tag: 'device',\n        deviceId,\n        deviceName,\n        groupDepth,\n        shouldHide,\n      },\n      string\n    );\n  }\n}\nexport async function startReactNativeServerAsync(\n  projectRoot: string,\n  options: Object = {},\n  verbose: boolean = true\n) {\n  await UserManager.ensureLoggedInAsync();\n  _assertValidProjectRoot(projectRoot);\n  await stopReactNativeServerAsync(projectRoot);\n  await Watchman.addToPathAsync(); // Attempt to fix watchman if it's hanging\n  await Watchman.unblockAndGetVersionAsync(projectRoot);\n  let packagerPort = await _getFreePortAsync(19001); // Create packager options\n  let packagerOpts = {\n    port: packagerPort,\n    projectRoots: projectRoot,\n    customLogReporterPath: 'expo/tools/LogReporter',\n    assetExts: ['ttf'],\n  };\n  let { exp } = await ProjectUtils.readConfigJsonAsync(projectRoot);\n  if (!Versions.gteSdkVersion(exp, '16.0.0')) {\n    delete packagerOpts.customLogReporterPath;\n  }\n  const userPackagerOpts = _.get(exp, 'packagerOpts');\n  if (userPackagerOpts) {\n    packagerOpts = {\n      ...packagerOpts,\n      ...userPackagerOpts,\n      ...(userPackagerOpts.assetExts\n        ? {\n            assetExts: _.uniq([\n              ...packagerOpts.assetExts,\n              ...userPackagerOpts.assetExts,\n            ]),\n          }\n        : {}),\n    };\n  }\n  let cliOpts = _.reduce(\n    packagerOpts,\n    (opts, val, key) => {\n      if (val && val !== '') {\n        opts.push(`--${key}`, val);\n      }\n      return opts;\n    },\n    ['start']\n  );\n  if (options.reset) {\n    cliOpts.push('--reset-cache');\n  } // Get custom CLI path from project package.json, but fall back to node_module path\n  let defaultCliPath = path.join(\n    projectRoot,\n    'node_modules',\n    'react-native',\n    'local-cli',\n    'cli.js'\n  );\n  const cliPath = _.get(exp, 'rnCliPath', defaultCliPath);\n  let nodePath; // When using a custom path for the RN CLI, we want it to use the project // root to look up config files and Node modules\n  if (exp.rnCliPath) {\n    nodePath = _nodePathForProjectRoot(projectRoot);\n  } else {\n    nodePath = null;\n  }\n  ProjectUtils.logInfo(\n    projectRoot,\n    'expo',\n    'Starting React Native packager...'\n  ); // Run the copy of Node that's embedded in Electron by setting the // ELECTRON_RUN_AS_NODE environment variable // Note: the CLI script sets up graceful-fs and sets ulimit to 4096 in the // child process\n  let packagerProcess = child_process.fork(cliPath, cliOpts, {\n    cwd: projectRoot,\n    env: {\n      ...process.env,\n      NODE_PATH: nodePath,\n      ELECTRON_RUN_AS_NODE: 1,\n    },\n    silent: true,\n  });\n  await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n    packagerPort,\n    packagerPid: packagerProcess.pid,\n  }); // TODO: do we need this? don't know if it's ever called\n  process.on('exit', () => {\n    treekill(packagerProcess.pid);\n  });\n  packagerProcess.stdout.setEncoding('utf8');\n  packagerProcess.stderr.setEncoding('utf8');\n  packagerProcess.stdout.on('data', data => {\n    if (verbose) {\n      _logPackagerOutput(projectRoot, 'info', data);\n    }\n  });\n  packagerProcess.stderr.on('data', data => {\n    if (verbose) {\n      _logPackagerOutput(projectRoot, 'error', data);\n    }\n  });\n  packagerProcess.on('exit', async code => {\n    ProjectUtils.logDebug(\n      projectRoot,\n      'expo',\n      `packager process exited with code ${code}`\n    );\n  });\n  let packagerUrl = await UrlUtils.constructBundleUrlAsync(projectRoot, {\n    urlType: 'http',\n    hostType: 'localhost',\n  });\n  await _waitForRunningAsync(`${packagerUrl}/debug`);\n} // Simulate the node_modules resolution // If you project dir is /Jesse/Expo/Universe/BubbleBounce, returns // \"/Jesse/node_modules:/Jesse/Expo/node_modules:/Jesse/Expo/Universe/node_modules:/Jesse/Expo/Universe/BubbleBounce/node_modules\"\nfunction _nodePathForProjectRoot(projectRoot: string): string {\n  let paths = [];\n  let directory = path.resolve(projectRoot);\n  while (true) {\n    paths.push(path.join(directory, 'node_modules'));\n    let parentDirectory = path.dirname(directory);\n    if (directory === parentDirectory) {\n      break;\n    }\n    directory = parentDirectory;\n  }\n  return paths.join(path.delimiter);\n}\nexport async function stopReactNativeServerAsync(projectRoot: string) {\n  await UserManager.ensureLoggedInAsync();\n  _assertValidProjectRoot(projectRoot);\n  let packagerInfo = await ProjectSettings.readPackagerInfoAsync(projectRoot);\n  if (!packagerInfo.packagerPort || !packagerInfo.packagerPid) {\n    ProjectUtils.logDebug(\n      projectRoot,\n      'expo',\n      `No packager found for project at ${projectRoot}.`\n    );\n    return;\n  }\n  ProjectUtils.logDebug(\n    projectRoot,\n    'expo',\n    `Killing packager process tree: ${packagerInfo.packagerPid}`\n  );\n  try {\n    await treekill.promise(packagerInfo.packagerPid, 'SIGKILL');\n  } catch (e) {\n    ProjectUtils.logDebug(\n      projectRoot,\n      'expo',\n      `Error stopping packager process: ${e.toString()}`\n    );\n  }\n  await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n    packagerPort: null,\n    packagerPid: null,\n  });\n}\nexport async function startExpoServerAsync(projectRoot: string) {\n  await UserManager.ensureLoggedInAsync();\n  _assertValidProjectRoot(projectRoot);\n  await stopExpoServerAsync(projectRoot);\n  let app = express();\n  app.use(\n    bodyParser.json({\n      limit: '10mb',\n    })\n  );\n  app.use(\n    bodyParser.urlencoded({\n      limit: '10mb',\n      extended: true,\n    })\n  );\n  if ((await Doctor.validateWithNetworkAsync(projectRoot)) === Doctor.FATAL) {\n    throw new Error(\n      `Couldn't start project. Please fix the errors and restart the project.`\n    );\n  } // Serve the manifest.\n  let manifestHandler = async (req, res) => {\n    try {\n      // We intentionally don't `await`. We want to continue trying even\n      // if there is a potential error in the package.json and don't want to slow\n      // down the request\n      Doctor.validateWithNetworkAsync(projectRoot);\n      let { exp: manifest } = await ProjectUtils.readConfigJsonAsync(\n        projectRoot\n      );\n\n      if (!manifest) {\n        const configName = await ProjectUtils.configFilenameAsync(projectRoot);\n        throw new Error(`No ${configName} file found`);\n      } // Get packager opts and then copy into bundleUrlPackagerOpts\n\n      let packagerOpts = await ProjectSettings.getPackagerOptsAsync(\n        projectRoot\n      );\n\n      let bundleUrlPackagerOpts = JSON.parse(JSON.stringify(packagerOpts));\n      bundleUrlPackagerOpts.urlType = 'http';\n      if (bundleUrlPackagerOpts.hostType === 'redirect') {\n        bundleUrlPackagerOpts.hostType = 'tunnel';\n      }\n      manifest.xde = true; // deprecated\n      manifest.developer = {\n        tool: Config.developerTool,\n      };\n\n      manifest.packagerOpts = packagerOpts;\n      manifest.env = {};\n      for (let key of Object.keys(process.env)) {\n        if (key.startsWith('REACT_NATIVE_') || key.startsWith('EXPO_')) {\n          manifest.env[key] = process.env[key];\n        }\n      }\n\n      let entryPoint = await Exp.determineEntryPointAsync(projectRoot);\n      let platform = req.headers['exponent-platform'] || 'ios';\n      entryPoint = UrlUtils.getPlatformSpecificBundleUrl(entryPoint, platform);\n      let mainModuleName = UrlUtils.guessMainModulePath(entryPoint);\n      let queryParams = await UrlUtils.constructBundleQueryParamsAsync(\n        projectRoot,\n        packagerOpts,\n        req.hostname\n      );\n      let path = `/${mainModuleName}.bundle?platform=${platform}&${queryParams}`;\n      manifest.bundleUrl =\n        (await UrlUtils.constructBundleUrlAsync(\n          projectRoot,\n          bundleUrlPackagerOpts,\n          req.hostname\n        )) + path;\n      manifest.debuggerHost = await UrlUtils.constructDebuggerHostAsync(\n        projectRoot,\n        req.hostname\n      );\n      manifest.mainModuleName = mainModuleName;\n      manifest.logUrl = `${await UrlUtils.constructManifestUrlAsync(projectRoot, { urlType: 'http' }, req.hostname)}/logs`; // Resolve manifest assets to their packager URL\n      await _resolveManifestAssets(\n        projectRoot,\n        manifest,\n        async path =>\n          manifest.bundleUrl.match(/^https?:\\/\\/.*?\\//)[0] + 'assets/' + path\n      ); // the server normally inserts this but if we're offline we'll do it here\n      const hostUUID = await UserSettings.anonymousIdentifier();\n      if (Config.offline) {\n        manifest.id = `@anonymous/${manifest.slug}-${hostUUID}`;\n      }\n      let manifestString = JSON.stringify(manifest);\n      let currentUser;\n      if (!Config.offline) {\n        currentUser = await UserManager.getCurrentUserAsync();\n      }\n      if (\n        req.headers['exponent-accept-signature'] &&\n        (currentUser || Config.offline)\n      ) {\n        if (_cachedSignedManifest.manifestString === manifestString) {\n          manifestString = _cachedSignedManifest.signedManifest;\n        } else {\n          if (Config.offline) {\n            const unsignedManifest = {\n              manifestString,\n              signature: 'UNSIGNED',\n            };\n            _cachedSignedManifest.manifestString = manifestString;\n            manifestString = JSON.stringify(unsignedManifest);\n            _cachedSignedManifest.signedManifest = manifestString;\n          } else {\n            let publishInfo = await Exp.getPublishInfoAsync(projectRoot);\n            let signedManifest = await Api.callMethodAsync(\n              'signManifest',\n              [publishInfo.args],\n              'post',\n              manifest\n            );\n            _cachedSignedManifest.manifestString = manifestString;\n            _cachedSignedManifest.signedManifest = signedManifest.response;\n            manifestString = signedManifest.response;\n          }\n        }\n      }\n      const hostInfo = {\n        host: hostUUID,\n        server: 'xdl',\n        serverVersion: require('../package.json').version,\n        serverDriver: Config.developerTool,\n        serverOS: os.platform(),\n        serverOSVersion: os.release(),\n      };\n      res.append('Exponent-Server', JSON.stringify(hostInfo));\n      res.send(manifestString);\n      Analytics.logEvent('Serve Manifest', {\n        projectRoot,\n      });\n    } catch (e) {\n      ProjectUtils.logDebug(\n        projectRoot,\n        'expo',\n        `Error in manifestHandler: ${e} ${e.stack}`\n      ); // 5xx = Server Error HTTP code\n      res.status(520).send({\n        error: e.toString(),\n      });\n    }\n  };\n  app.get('/', manifestHandler);\n  app.get('/manifest', manifestHandler);\n  app.get('/index.exp', manifestHandler);\n  app.post('/logs', async (req, res) => {\n    try {\n      let deviceId = req.get('Device-Id');\n      let deviceName = req.get('Device-Name');\n      if (deviceId && deviceName && req.body) {\n        _handleDeviceLogs(projectRoot, deviceId, deviceName, req.body);\n      }\n    } catch (e) {\n      ProjectUtils.logError(\n        projectRoot,\n        'expo',\n        `Error getting device logs: ${e} ${e.stack}`\n      );\n    }\n    res.send('Success');\n  });\n  app.post('/shutdown', async (req, res) => {\n    server.close();\n    res.send('Success');\n  });\n  let expRc = await ProjectUtils.readExpRcAsync(projectRoot);\n  let expoServerPort = expRc.manifestPort\n    ? expRc.manifestPort\n    : await _getFreePortAsync(19000);\n  await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n    expoServerPort,\n  });\n  let server = app.listen(expoServerPort, () => {\n    let host = server.address().address;\n    let port = server.address().port;\n    ProjectUtils.logDebug(\n      projectRoot,\n      'expo',\n      `Local server listening at http://${host}:${port}`\n    );\n  });\n  await Exp.saveRecentExpRootAsync(projectRoot);\n}\nexport async function stopExpoServerAsync(projectRoot: string) {\n  await UserManager.ensureLoggedInAsync();\n  _assertValidProjectRoot(projectRoot);\n  let packagerInfo = await ProjectSettings.readPackagerInfoAsync(projectRoot);\n  if (packagerInfo && packagerInfo.expoServerPort) {\n    try {\n      await request.post.promise(\n        `http://localhost:${packagerInfo.expoServerPort}/shutdown`\n      );\n    } catch (e) {}\n  }\n  await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n    expoServerPort: null,\n  });\n}\nasync function _connectToNgrokAsync(\n  projectRoot: string,\n  args: mixed,\n  hostnameAsync: Function,\n  ngrokPid: ?number,\n  attempts: number = 0\n) {\n  try {\n    let configPath = path.join(\n      UserSettings.dotExpoHomeDirectory(),\n      'ngrok.yml'\n    );\n    let hostname = await hostnameAsync();\n    let url = await ngrok.promise.connect({\n      hostname,\n      configPath,\n      ...args,\n    });\n    return url;\n  } catch (e) {\n    // Attempt to connect 3 times\n    if (attempts >= 2) {\n      if (e.message) {\n        throw new XDLError(ErrorCode.NGROK_ERROR, e.toString());\n      } else {\n        throw new XDLError(ErrorCode.NGROK_ERROR, JSON.stringify(e));\n      }\n    }\n    if (!attempts) {\n      attempts = 0;\n    } // Attempt to fix the issue\n    if (e.error_code && e.error_code === 103) {\n      if (attempts === 0) {\n        // Failed to start tunnel. Might be because url already bound to another session.\n        if (ngrokPid) {\n          try {\n            process.kill(ngrokPid, 'SIGKILL');\n          } catch (e) {\n            ProjectUtils.logDebug(\n              projectRoot,\n              'expo',\n              `Couldn't kill ngrok with PID ${ngrokPid}`\n            );\n          }\n        } else {\n          await ngrok.promise.kill();\n        }\n      } else {\n        // Change randomness to avoid conflict if killing ngrok didn't help\n        await Exp.resetProjectRandomnessAsync(projectRoot);\n      }\n    } // Wait 100ms and then try again\n    await delayAsync(100);\n    return _connectToNgrokAsync(\n      projectRoot,\n      args,\n      hostnameAsync,\n      null,\n      attempts + 1\n    );\n  }\n}\nexport async function startTunnelsAsync(projectRoot: string) {\n  const user = await UserManager.ensureLoggedInAsync();\n  if (!user) {\n    throw new Error('Internal error -- tunnel started in offline mode.');\n  }\n  _assertValidProjectRoot(projectRoot);\n  let packagerInfo = await ProjectSettings.readPackagerInfoAsync(projectRoot);\n  if (!packagerInfo.packagerPort) {\n    throw new XDLError(\n      ErrorCode.NO_PACKAGER_PORT,\n      `No packager found for project at ${projectRoot}.`\n    );\n  }\n  if (!packagerInfo.expoServerPort) {\n    throw new XDLError(\n      ErrorCode.NO_EXPO_SERVER_PORT,\n      `No Expo server found for project at ${projectRoot}.`\n    );\n  }\n  await stopTunnelsAsync(projectRoot);\n  if (await Android.startAdbReverseAsync(projectRoot)) {\n    ProjectUtils.logInfo(\n      projectRoot,\n      'expo',\n      'Sucessfully ran `adb reverse`. Localhost urls should work on the connected Android device.',\n      'project-adb-reverse'\n    );\n  } else {\n    ProjectUtils.clearNotification(projectRoot, 'project-adb-reverse');\n  }\n  const { username } = user;\n  let packageShortName = path.parse(projectRoot).base;\n  let expRc = await ProjectUtils.readExpRcAsync(projectRoot);\n  try {\n    let expoServerNgrokUrl = await _connectToNgrokAsync(\n      projectRoot,\n      {\n        authtoken: Config.ngrok.authToken,\n        port: packagerInfo.expoServerPort,\n        proto: 'http',\n      },\n      async () => {\n        let randomness = expRc.manifestTunnelRandomness\n          ? expRc.manifestTunnelRandomness\n          : await Exp.getProjectRandomnessAsync(projectRoot);\n        return [\n          randomness,\n          UrlUtils.domainify(username),\n          UrlUtils.domainify(packageShortName),\n          Config.ngrok.domain,\n        ].join('.');\n      },\n      packagerInfo.ngrokPid\n    );\n    let packagerNgrokUrl = await _connectToNgrokAsync(\n      projectRoot,\n      {\n        authtoken: Config.ngrok.authToken,\n        port: packagerInfo.packagerPort,\n        proto: 'http',\n      },\n      async () => {\n        let randomness = expRc.manifestTunnelRandomness\n          ? expRc.manifestTunnelRandomness\n          : await Exp.getProjectRandomnessAsync(projectRoot);\n        return [\n          'packager',\n          randomness,\n          UrlUtils.domainify(username),\n          UrlUtils.domainify(packageShortName),\n          Config.ngrok.domain,\n        ].join('.');\n      },\n      packagerInfo.ngrokPid\n    );\n    await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n      expoServerNgrokUrl,\n      packagerNgrokUrl,\n      ngrokPid: ngrok.process().pid,\n    });\n  } catch (e) {\n    ProjectUtils.logError(\n      projectRoot,\n      'expo',\n      `Error starting tunnel: ${e.toString()}`\n    );\n    throw e;\n  }\n}\nexport async function stopTunnelsAsync(projectRoot: string) {\n  await UserManager.ensureLoggedInAsync();\n  _assertValidProjectRoot(projectRoot); // This will kill all ngrok tunnels in the process. // We'll need to change this if we ever support more than one project // open at a time in XDE.\n  let packagerInfo = await ProjectSettings.readPackagerInfoAsync(projectRoot);\n  let ngrokProcess = ngrok.process();\n  let ngrokProcessPid = ngrokProcess ? ngrokProcess.pid : null;\n  if (packagerInfo.ngrokPid && packagerInfo.ngrokPid !== ngrokProcessPid) {\n    // Ngrok is running in some other process. Kill at the os level.\n    try {\n      process.kill(packagerInfo.ngrokPid);\n    } catch (e) {\n      ProjectUtils.logDebug(\n        projectRoot,\n        'expo',\n        `Couldn't kill ngrok with PID ${packagerInfo.ngrokPid}`\n      );\n    }\n  } else {\n    // Ngrok is running from the current process. Kill using ngrok api.\n    await ngrok.promise.kill();\n  }\n  await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n    expoServerNgrokUrl: null,\n    packagerNgrokUrl: null,\n    ngrokPid: null,\n  });\n  await Android.stopAdbReverseAsync(projectRoot);\n}\nexport async function setOptionsAsync(\n  projectRoot: string,\n  options: {\n    packagerPort?: number,\n  }\n) {\n  await UserManager.ensureLoggedInAsync();\n  _assertValidProjectRoot(projectRoot); // Check to make sure all options are valid\n  let schema = joi.object().keys({\n    packagerPort: joi.number().integer(),\n  });\n  try {\n    await joi.promise.validate(options, schema);\n  } catch (e) {\n    throw new XDLError(ErrorCode.INVALID_OPTIONS, e.toString());\n  }\n  await ProjectSettings.setPackagerInfoAsync(projectRoot, options);\n}\nexport async function getUrlAsync(projectRoot: string, options: Object = {}) {\n  await UserManager.ensureLoggedInAsync();\n  _assertValidProjectRoot(projectRoot);\n  return await UrlUtils.constructManifestUrlAsync(projectRoot, options);\n}\nexport async function startAsync(\n  projectRoot: string,\n  options: Object = {},\n  verbose: boolean = true\n): Promise<any> {\n  await UserManager.ensureLoggedInAsync();\n  _assertValidProjectRoot(projectRoot);\n  Analytics.logEvent('Start Project', {\n    projectRoot,\n  });\n  await startExpoServerAsync(projectRoot);\n  await startReactNativeServerAsync(projectRoot, options, verbose);\n  if (!Config.offline) {\n    try {\n      await startTunnelsAsync(projectRoot);\n    } catch (e) {\n      ProjectUtils.logDebug(\n        projectRoot,\n        'expo',\n        `Error starting ngrok ${e.message}`\n      );\n    }\n  }\n  let { exp } = await ProjectUtils.readConfigJsonAsync(projectRoot);\n  return exp;\n}\nasync function _stopInternalAsync(projectRoot: string): Promise<void> {\n  await stopExpoServerAsync(projectRoot);\n  await stopReactNativeServerAsync(projectRoot);\n  if (!Config.offline) {\n    try {\n      await stopTunnelsAsync(projectRoot);\n    } catch (e) {\n      ProjectUtils.logDebug(\n        projectRoot,\n        'expo',\n        `Error stopping ngrok ${e.message}`\n      );\n    }\n  }\n}\nexport async function stopAsync(projectDir: string): Promise<void> {\n  const result = await Promise.race([\n    _stopInternalAsync(projectDir),\n    new Promise((resolve, reject) => setTimeout(resolve, 2000, 'stopFailed')),\n  ]);\n  if (result === 'stopFailed') {\n    // find RN packager and ngrok pids, attempt to kill them manually\n    const {\n      packagerPid,\n      ngrokPid,\n    } = await ProjectSettings.readPackagerInfoAsync(projectDir);\n    if (packagerPid) {\n      try {\n        process.kill(packagerPid);\n      } catch (e) {}\n    }\n    if (ngrokPid) {\n      try {\n        process.kill(ngrokPid);\n      } catch (e) {}\n    }\n    await ProjectSettings.setPackagerInfoAsync(projectDir, {\n      expoServerPort: null,\n      packagerPort: null,\n      packagerPid: null,\n      expoServerNgrokUrl: null,\n      packagerNgrokUrl: null,\n      ngrokPid: null,\n    });\n  }\n}\n"],"sourceRoot":"/xdl/src"}